name: Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:  # Allow manual trigger

jobs:
  # Job 1: Build and run unit tests
  unit-tests:
    name: Unit Tests (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [17, 21]
      fail-fast: false  # Continue other jobs even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run unit tests
        run: mvn clean test -B

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-jdk${{ matrix.java }}
          path: target/surefire-reports/
          retention-days: 7

  # Job 2: Build and run integration tests
  integration-tests:
    name: Integration Tests (JDK ${{ matrix.java }})
    runs-on: ubuntu-latest
    needs: unit-tests  # Run after unit tests pass

    strategy:
      matrix:
        java: [17, 21]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run integration tests
        run: mvn verify -DskipTests -B
        # -DskipTests skips unit tests (already run)
        # verify runs integration-test phase (Failsafe plugin)

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-jdk${{ matrix.java }}
          path: target/failsafe-reports/
          retention-days: 7

  # Job 3: Full build with both test types
  full-build:
    name: Full Build & Package (JDK 21)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and package
        run: mvn clean package -B

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: redis-utils-jar
          path: target/*.jar
          retention-days: 7

  # Job 4: Code quality and coverage (optional)
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile code
        run: mvn clean compile -B

      # Add additional quality checks here:
      # - SpotBugs, PMD, Checkstyle
      # - Code coverage with JaCoCo
      # - Dependency vulnerability scanning

      - name: Check for vulnerabilities (optional)
        run: mvn dependency:analyze -B
        continue-on-error: true

  # Summary job that reports overall status
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, full-build]
    if: always()

    steps:
      - name: Check status
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Full Build: ${{ needs.full-build.result }}"

          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.full-build.result }}" != "success" ]; then
            echo "CI Pipeline Failed!"
            exit 1
          fi

          echo "CI Pipeline Passed!"
